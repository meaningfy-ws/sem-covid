# TEMPLATE query to extract documents from Cellar
# This template needs to be provided the selection criteria for Cellar ?works;
# and it will bring the most important metadata about those works.

PREFIX cdm: <http://publications.europa.eu/ontology/cdm#>
PREFIX lang: <http://publications.europa.eu/resource/authority/language/>
PREFIX res_type: <http://publications.europa.eu/resource/authority/resource-type/>
PREFIX skos: <http://www.w3.org/2004/02/skos/core#>
PREFIX owl: <http://www.w3.org/2002/07/owl#>
PREFIX subj_mat: <http://publications.europa.eu/resource/authority/subject-matter/>

PREFIX ev: <http://eurovoc.europa.eu/>

PREFIX fd_030: <http://publications.europa.eu/resource/authority/fd_030/>

SELECT DISTINCT
    ?work
    (group_concat(DISTINCT ?_title; separator="| ") as ?title)

WHERE {
    # selector criteria
    VALUES ?expr_lang { lang:ENG }
    VALUES ?eurovoc_concept {
        ev:1005
                ev:1021
                ev:1129
                ev:1488
                ev:1804
                ev:2002
                ev:4585
                ev:616
                ev:1452
                ev:3246
#                ev:5868
#                ev:1476
#                ev:1638
#                ev:504
#                ev:5455
#                ev:1281
#                ev:189
#                ev:4195
#                ev:8469
#                ev:1052
#                ev:1132
#                ev:935
#                ev:2098
#                ev:554
#                ev:1310
#                ev:2216
#                ev:365
#                ev:408
#                ev:4392
#                ev:549
#                ev:6029
#                ev:8468
#                ev:248
#                ev:3878
#                ev:4347
#                ev:4646
#                ev:766
#                ev:1095
#                ev:1676
#                ev:2264
#                ev:5157
#                ev:635
#                ev:1234
#                ev:1630
#                ev:2463
#                ev:4763
#                ev:7942
#                ev:1156
#                ev:1164
#                ev:561
#                ev:6342
#                ev:4493
#                ev:2805
#                ev:521
#                ev:3951
#                ev:2150
#                ev:2386
#                ev:1328
#                ev:2220
#                ev:871
#                ev:1497
#                ev:5090
#                ev:57
#                ev:924
#                ev:3240
#                ev:3942
#                ev:1130
#                ev:1326
#                ev:5156
#                ev:5645
#                ev:6343
#                ev:1971
#                ev:2149
#                ev:2831
#                ev:4115
#                ev:1459
#                ev:560
#                ev:1972
#                ev:5964
#                ev:4250
#                ev:5465
#                ev:5598
#                ev:170
#                ev:2839
#                ev:4491
#                ev:6362
#                ev:728
#                ev:1787
#                ev:834
#                ev:3148
#                ev:4855
#                ev:2219
#                ev:5566
#                ev:c_406ad4cc
#                ev:c_dcc650ef
#                ev:c_3e6af2e7
#                ev:c_8f89faac
#                ev:c_96124aaf
#                ev:c_b499ede2
#                ev:c_a18525ab
#                ev:c_e749c083
#                ev:c_dd52c1e9
#                ev:c_dcf3f7c0
#                ev:c_a3b85311
#                ev:1000
#                ev:1460
#                ev:2497
#                ev:2900
#                ev:4838
#                ev:2504
#                ev:1448
#                ev:4190
#                ev:6751
#                ev:165
#                ev:2607
#                ev:1492
#                ev:5389
#                ev:5218
#                ev:3543
#                ev:3233
#                ev:1801
#                ev:1815
#                ev:4703
#                ev:2162
#                ev:55
#                ev:3119
#                ev:1491
#                ev:115
#                ev:524
#                ev:1490
#                ev:822
#                ev:4406
#                ev:3235
#                ev:c_14d71455
#                ev:c_7f2d2214
#                ev:c_d08207d1
#                ev:1313
#                ev:4279
    }

    VALUES ?resource_type {
        res_type:REG
        fd_030:REGL
        res_type:DIR
        res_type:REG_IMPL
        res_type:REG_DEL
        fd_030:DIRECTIVE
        fd_030:REGIMP
        fd_030:REGDEL
        res_type:DIR_DEL
        res_type:DIR_IMPL
        res_type:REG_FINANC
        fd_030:DIRDEL
        fd_030:DIRIMP
        fd_030:DIR
        fd_030:REG
    }

#    VALUES ?resource_type_property { cdm:work_has_resource-type cdm:resource_legal_has_type_act_concept_type_act }

    ?work cdm:work_is_about_concept_eurovoc ?eurovoc_concept .
#    ?work cdm:work_has_resource-type|cdm:resource_legal_has_type_act_concept_type_act ?resource_type . # ~ 20s - 407
    ?work cdm:work_has_resource-type|cdm:resource_legal_has_type_act_concept_type_act ?resource_type . # ~ 1m27s - 5096
#    ?work cdm:work_has_resource-type ?resource_type . # ~ 10S - 407 # concepts 1
#    ?work cdm:work_has_resource-type ?resource_type . # ~ 2m35s - 5720 # concepts 138
#    ?work cdm:work_has_resource-type ?resource_type . # ~ 55s - 5096 # concepts 10
#    ?work cdm:resource_legal_has_type_act_concept_type_act ?resource_type . # ~10s - 379
#    ?work ?resource_type_property ?resource_type . # ~2m - 367


    # metadata - classification criteria
    OPTIONAL {
        ?work a ?cdm_type .
        OPTIONAL {
            ?cdm_type skos:prefLabel ?cdm_type_label .
            FILTER (lang(?cdm_type_label)="en")
        }
    }
    OPTIONAL {
        ?work cdm:work_has_resource-type ?resource_type .
        OPTIONAL {
            ?resource_type skos:prefLabel ?resource_type_label .
            FILTER (lang(?resource_type_label)="en")
        }
    }
    OPTIONAL {
        ?work cdm:resource_legal_is_about_subject-matter ?subject_matter .
        OPTIONAL {
            ?subject_matter skos:prefLabel ?subject_matter_label .
            FILTER (lang(?subject_matter_label)="en")
        }
    }
    OPTIONAL {
        ?work cdm:resource_legal_is_about_concept_directory-code ?directory_code .
        OPTIONAL {
            ?directory_code skos:prefLabel ?directory_code_label .
            FILTER (lang(?directory_code_label)="en")
        }
    }
    OPTIONAL {
        ?work cdm:work_is_about_concept_eurovoc ?eurovoc_concept .
        OPTIONAL {
            ?eurovoc_concept skos:prefLabel ?eurovoc_concept_label .
            FILTER (lang(?eurovoc_concept_label)="en")
        }
    }

    # metadata - descriptive criteria
    OPTIONAL {
        ?work cdm:work_created_by_agent ?author .
        OPTIONAL {
            ?author skos:prefLabel ?author_label .
            FILTER (lang(?author_label)="en")
        }
    }
    OPTIONAL {
        ?work cdm:resource_legal_in-force ?in_force .
    }
    OPTIONAL {
        ?work cdm:resource_legal_id_sector ?oj_sector .
    }
    OPTIONAL {
        ?work cdm:resource_legal_published_in_official-journal ?full_oj .
    }
    OPTIONAL {
        ?work cdm:resource_legal_comment_internal ?internal_comment .
    }
    OPTIONAL {
        ?work cdm:work_date_document ?date_document .
    }
    OPTIONAL {
        ?work cdm:work_date_creation ?date_created .
    }
    OPTIONAL {
        ?work cdm:resource_legal_date_signature ?legal_date_signature .
    }
    OPTIONAL {
        ?work cdm:resource_legal_date_entry-into-force ?legal_date_entry_into_force .
    }

    # metadata - identification properties
    OPTIONAL {
        ?work cdm:resource_legal_id_celex ?celex .
    }
    OPTIONAL {
        ?work cdm:resource_legal_eli ?legal_eli .
    }
    OPTIONAL {
        ?work cdm:work_id_document ?id_document .
    }
    OPTIONAL {
        ?work owl:sameAs ?same_as_uri .
    }

    # diving down FRBR structure for the title and the content
    OPTIONAL {
        ?exp cdm:expression_belongs_to_work ?work ;
            cdm:expression_uses_language ?expr_lang ;
            cdm:expression_title ?_title .

        OPTIONAL {
            ?manif_pdf cdm:manifestation_manifests_expression ?exp ;
                cdm:manifestation_type ?type_pdf .
            FILTER (str(?type_pdf) in ('pdf', 'pdfa1a', 'pdfa2a', 'pdfa1b', 'pdfx'))
        }
        OPTIONAL {
            ?manif_html cdm:manifestation_manifests_expression ?exp ;
                cdm:manifestation_type ?type_html .
            FILTER (str(?type_html) in ('html', 'xhtml'))
        }
    }
    BIND(IRI(concat(?manif_pdf,"/zip")) as ?pdf_to_download)
    BIND(IRI(concat(?manif_html,"/zip")) as ?html_to_download)
}
GROUP BY ?work
ORDER BY ?work